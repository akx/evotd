(function(){function F(e,t){function n(){}n.prototype=(e.superclass=t).prototype;(e.prototype=new n).constructor=e;typeof t.extended=="function"&&t.extended(e);return e}function I(e,t){return function(){return e[t].apply(e,arguments)}}var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j;e=function(e,t){var n,r=[];t==null&&(t=8);for(n=0;n<t;++n)r.push(!!(e&1<<n));return r};t=function(e){var t,n,r,i;t=0;for(n=0,r=e.length;n<r;++n){i=e[n];i&&(t|=1<<n)}return t};n=function(e,t,n){return t*n+e*(1-n)};r=function(e,t){return(e+Math.random()*(t-e))*(Math.random()<.5?-1:1)};i=function(e,t){return e+Math.random()*(t-e)};s=function(e,t){return 0|e+Math.random()*(t-e)};o=function(e){return e[s(0,e.length)]};u=function(e,t,n){var r,i;r=e.x-t.x;i=e.y-t.y;return r*r+i*i<n*n};a=function(e,t,n){var r,i,s,o,u,a,f,l=[];r=Math.cos(t*n.wd);i=Math.sin(t*n.zd);s=n.R-n.r;for(o=0;o<25;o+=.1){u=s/n.r*o;a=s*Math.cos(o)+n.d*Math.cos(r+u);f=s*Math.sin(o)-n.d*Math.sin(i-u);o==0?l.push(e.moveTo(a,f)):l.push(e.lineTo(a,f))}return l};f=function(){return{R:15+Math.random()*15,r:5+Math.random()*10,d:Math.random()*5,wd:r(1.1,1.4),zd:r(1.1,1.4)}};l="Corbel, Segoe UI, Frutiger Linotype, sans-serif";c=function(e,t){return{x:e,y:t,id:e+","+t}};h=function(e,t,n){function w(e,t){return a[e.id]-a[t.id]}var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b;r={};i=[];s={};o={};u={};a={};f=function(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)};l=function(e,t){var n,r;n=e.x-t.x;r=e.y-t.y;return Math.sqrt(n*n+r*r)};c=function(e,t){i.push(e);s[e.id]=1;u[e.id]=t};h=function(e){a[e.id]=u[e.id]+f(e,t)};p=function(){var e,n,r;e=t;n=[];while(r=o[e.id]){n.unshift(r);e=r}return n};c(e,0);h(e);while(i.length){i=i.sort(w);d=i.shift();delete s[d.id];if(d.id==t.id)return p();r[d.id]=1;for(v=0,g=(m=n(d)).length;v<g;++v){y=m[v];if(r[y.id])continue;b=u[d.id]+l(d,y);if(!s[y.id]||b<u[y.id]){c(y,b);o[y.id]=d;a[y.id]=u[y.id]+f(y,t)}}}return null};p={};d=!0;v=function(e,t){var n;n=new Audio;n.setAttribute("src",t);n.load();return p[e]=n};m=function(e){var t;if(!d)return;t=p[e];return t.play()};g=function(){function n(){}n.displayName="Gene";var e=n.prototype,t=n;e.initialize=function(){};e.evolve=function(e,t,n){n==null&&(n=0)};return n}();y=function(e){function i(){}i.displayName="EightBitGene";var n=F(i,e).prototype,r=i;n.initialize=function(){return Math.random()};n.evolve=function(e,n,r){var i,s,o,u,a,f;r==null&&(r=0);i=eightBits(e*255);s=eightBits(n*255);o=[];for(u=0;u<8;++u){a=Math.random()<.5;Math.random()<r?o.push(a):a?o.push(i[u]):o.push(s[u])}f=o;return t(f)/256};return i}(g);b=function(e){function s(){}s.displayName="FloatGene";var t=F(s,e).prototype,r=s;t.initialize=function(){return Math.random()};t.evolve=function(e,t,r){r==null&&(r=0);return Math.random()<r?this.initialize():n(e,t,i(.3,.7))};return s}(g);w=function(){function n(e){this.genes=e}n.displayName="Genome";var e=n.prototype,t=n;e.initialize=function(){var e,t,n,r;e={};for(t in n=this.genes){r=n[t];e[t]=r.initialize()}return e};e.evolve=function(e,t,n){var r,i,s,o,u,a,f;n==null&&(n=0);e=e.attributes||e;t=t.attributes||t;r={};for(i in s=this.genes){o=s[i];u=e[i];a=t[i];u!==undefined&&a!==undefined?f=o.evolve(u,a,n):f=o.initialize();r[i]=f}return r};return n}();E=function(){function n(){this.gridX=this.gridY=this.x=this.y=0}n.displayName="GridObject";var e=n.prototype,t=n;e.setGridCoords=function(e,t){this.x=(this.gridX=0|e)*32+16;this.y=(this.gridY=0|t)*32+16};e.updateGridCoordsFromXY=function(){this.gridX=0|this.x/32;this.gridY=0|this.y/32};return n}();S=function(e){function i(t){var r;this.attributes=t;e.call(this);this.nextReload=0;this.nextShot=0;this.nextAcquisition=0;this.health=this.maxHealth=5;this.damageBlip=!1;this.generation=0;this.actual={maxAmmo:0|n(1,50,this.attributes.reloadAmmo),shotInterval:1/n(3,20,this.attributes.shootSpeed),acqInterval:n(4,.3,this.attributes.acquisitionSpeed),maxRange:0|n(48,200,this.attributes.maxRange),reloadTime:n(1,5,this.attributes.reloadSpeed),ammoDamage:n(1,35,this.attributes.ammoDamage),ammoSpeed:n(3,20,this.attributes.ammoSpeed),ammoRange:n(80,400,this.attributes.ammoRange),ammoDeceleration:this.attributes.ammoDeceleration,slowingAmmo:this.attributes.slowingAmmo>.75,homingAmmo:this.attributes.homingAmmo>.85};this.actual.dps=this.actual.ammoDamage/(1/this.actual.shotInterval);this.depletionTime=this.actual.maxAmmo*this.actual.shotInterval+.1;this.reload();r=0|this.attributes.hue*360;this.fillStyle="hsl("+r+",100%,50%)"}i.displayName="Tower";var t=F(i,e).prototype,r=i;t.reload=function(){this.ammo=this.actual.maxAmmo;this.nextShot=0;this.nextReload=0;return this.reloading=!1};t.beginReload=function(){this.reloading=!0;return this.nextReload=D+this.depletionTime+this.actual.reloadTime};t.reacquire=function(){var e,t,n,r,i,s,o,u,a,f;this.unacquire();e=null;t=0;n=this.actual.maxRange*this.actual.maxRange;for(r=0,s=(i=_.creeps).length;r<s;++r){o=i[r];u=this.x-o.x;a=this.y-o.y;f=u*u+a*a;if((!e||f<t)&&f<n){t=f;e=o}}this.acquiredEnemy=e;return this.nextShot=D+this.actual.shotInterval};t.unacquire=function(){this.acquiredEnemy=null;this.nextAcquisition=D+this.actual.acqInterval};t.step=function(){this.onStage=!0;D>=this.nextAcquisition&&this.reacquire();this.ammo<=0&&(this.nextReload<=0?this.beginReload():D>=this.nextReload&&this.reload());if(this.acquiredEnemy){if(!u(this,this.acquiredEnemy,this.actual.maxRange))return this.unacquire();if(this.ammo>0&&D>=this.nextShot){this.nextShot=D+this.actual.shotInterval;if(this.acquiredEnemy.dead)return this.acquiredEnemy=null;this.shoot(this.acquiredEnemy);return this.ammo--}}};t.shoot=function(e){var t;t=new k(this.x,this.y,this.fillStyle,this.actual,e);_.ammo.push(t);return m("shoot")};t.draw=function(e){var t,r,i,s,o,u,a,f;t=8+this.attributes.height*48;r=3+this.attributes.baseWidth*27;i=3+this.attributes.topWidth*17;e.font="12px "+l;e.strokeStyle="transparent";for(s=0;s<t;s+=3){o=1-s/t;o=Math.pow(o,this.attributes.form*2);u=n(i,r,o);a=n(this.attributes.hue*360,this.attributes.hueTop*360,o);e.fillStyle=this.damageBlip?"white":"hsl("+a+", 100%, 50%)";e.beginPath();e.arc(0,-s,u/2,0,6.282);e.fill()}this.damageBlip=!1;if(this.onStage){if(this.ammo>0){e.beginPath();f=n(0,32,this.ammo/this.actual.maxAmmo);e.rect(-16,14,f,2);e.fill()}e.fillStyle="white";if(this.reloading&&D*2&1){e.beginPath();e.fillText("R",-2,0)}if(!this.reloading&&!this.acquiredEnemy){e.beginPath();e.fillText("?",-2,0)}}};t.damage=function(){this.health--;this.damageBlip=!0;m("tower-hurt");if(this.health<=0)return this.dead=!0};return i}(E);x=function(e){function s(){e.call(this);this.ljParams=f();this.figureOutNextSpawn(5);this.pool=[j.initialize(),j.initialize(),j.initialize(),j.initialize(),j.initialize()];this.enemiesLeft=this.enemiesTotal=300;this.enemiesSpawned=0}s.displayName="Spawner";var t=F(s,e).prototype,r=s;t.figureOutNextSpawn=function(e){var t;e==null&&(e=1);t=i(.75,4)*e;return this.nextSpawn=D+t};t.draw=function(e){var t;e.save();e.rotate(D);e.beginPath();e.strokeStyle="red";e.lineWidth=1;a(e,D,this.ljParams);e.stroke();e.restore();if(this.nextSpawn>0){t=Math.min(1,(this.nextSpawn-D)/5);e.strokeStyle="white";e.beginPath();e.lineWidth=1;e.arc(0,0,8+Math.cos(D)*4,0,n(0,6.282,t));e.stroke()}};t.step=function(){if(!_.gameOver&&this.enemiesLeft&&this.nextSpawn&&D>=this.nextSpawn){this.figureOutNextSpawn();this.spawn()}};t.spawn=function(){var e,t,n;this.enemiesLeft--;this.enemiesSpawned++;e=[].concat(this.pool).concat(_.creeps);e.length&&Math.random()>.95?t=j.evolve(o(e),o(e),_.enemyMutationRate):t=j.initialize();n=new C(t);n.spawner=this;n.setGridCoords(this.gridX,this.gridY);n.reroute();_.creeps.push(n)};return s}(E);T=function(e){function i(){e.call(this);this.ljParams=f();this.health=this.maxHealth=50;this.damageBlip=0}i.displayName="Heart";var t=F(i,e).prototype,r=i;t.damage=function(){this.health--;this.damageBlip=15;m("core-hit")};t.draw=function(e){e.strokeStyle="lime";this.life<this.maxLife*.5&&D*3%1<.5&&(e.strokeStyle="orange");if(this.damageBlip>0){this.damageBlip--;D*5%1<.5&&(e.strokeStyle="white")}e.save();e.rotate(-D);e.beginPath();e.lineWidth=1;a(e,D,this.ljParams);e.stroke();e.restore();if(this.life<this.maxLife){e.strokeStyle="white";e.save();e.rotate(D*3);e.beginPath();e.lineWidth=1;e.arc(0,0,8+Math.cos(D)*2,0,n(0,6.282,this.life/this.maxLife));e.stroke();e.restore()}};return i}(E);N=function(e){function r(){e.call(this);this.blocking=!0}r.displayName="Boulder";var t=F(r,e).prototype,n=r;t.draw=function(e){e.beginPath();e.fillStyle="#444";e.strokeStyle="silver";e.lineWidth=2;e.rect(-12,-12,24,24);e.fill();e.stroke();e.beginPath();e.fillStyle="#666";e.rect(-12,-24,24,24);e.fill();e.stroke()};return r}(E);C=function(e){function i(t){this.attributes=t;e.call(this);this.route=null;this.actualSpeed=n(2,12,this.attributes.speed)*Math.sqrt(this.attributes.health);this.actualSize=n(6,32,this.attributes.size)/2;this.maxHealth=this.health=0|n(30,500,this.attributes.health);this.dx=this.dy=0}i.displayName="Enemy";var t=F(i,e).prototype,r=i;t.draw=function(e){var t,r,i,s;t=0|this.attributes.hue*360;r=(this.attributes.hue-.5)*D*(1+this.attributes.speed)*10;i="hsl("+t+", 30%, 50%)";e.beginPath();if(this.damageBlip){i="white";this.damageBlip=!1}e.fillStyle=e.strokeStyle=i;e.lineWidth=this.rage&&D*3%1<.5?6:2;e.arc(0,0,this.actualSize,r,r+4.7);e.stroke();if(this.health>0&&this.health<this.maxHealth){e.beginPath();s=n(0,32,this.health/this.maxHealth);e.rect(-16,14,s,2);e.fill()}};t.step=function(){var e,t,r,i,s,o,u,a,f,l,c;e=this.lastTime||D;t=D-e;if(this.route&&this.route.length){r=this.route[0];this.rage=!1}else{r={worldX:_.heart.x,worldY:_.heart.y};this.rage=!0;Math.random()<.1&&this.reroute()}if(r){i=r.worldX-this.x;s=r.worldY-this.y;o=i*i+s*s;if(o<25)this.route.shift();else{u=Math.atan2(s,i);a=Math.min(Math.sqrt(o),this.actualSpeed)*(this.rage?3:1);f=Math.cos(u)*a;l=Math.sin(u)*a;this.dx=n(this.dx,f,.5);this.dy=n(this.dy,l,.5)}}this.x+=this.dx;this.y+=this.dy;this.updateGridCoordsFromXY();this.rage&&(c=_.checkGridObj(_.towers,this.gridX,this.gridY))&&c.damage();if(this.gridX==_.heart.gridX&&this.gridY==_.heart.gridY){this.dead=!0;_.heart.damage();this.spawner.pool.push(this.attributes)}this.lastTime=D};t.reroute=function(){var e,t,n,r,i,o;this.updateGridCoordsFromXY();e=c(this.gridX,this.gridY);t=c(_.heart.gridX,_.heart.gridY);n=h(e,t,I(_,"getAstarNeighbors"));if(!n){console.log("COULD NOT FIND ROUTE",e,t);this.route=null;return}n.push(t);for(r=0,i=n.length;r<i;++r){o=n[r];o.worldX=o.x*32+s(4,28);o.worldY=o.y*32+s(4,28)}this.route=n};t.damage=function(e){var t;if(this.health<=0)return;this.health-=e;this.damageBlip=!0;if(this.health<=0){t=2|Math.ceil(this.maxHealth/75);_.credits+=t;this.dead=!0;return m("kill")}return m("ammo-hit")};return i}(E);k=function(e){function i(e,t,r,i,s){var o,u,a;this.x=e;this.y=t;this.fillStyle=r;this.attributes=i;this.target=s;o=Math.atan2(this.target.y-this.y,this.target.x-this.x);this.dx=Math.cos(o)*this.attributes.ammoSpeed;this.dy=Math.sin(o)*this.attributes.ammoSpeed;this.initialX=this.x;this.initialY=this.y;u=this.attributes.ammoRange;this.rangeSq=u*u;a=this.attributes.ammoSpeed*Math.max(1,Math.sqrt(this.attributes.ammoDamage*.25));this.size=Math.max(2,Math.min(7,a))*.6;this.decel=n(1,.95,this.attributes.ammoDeceleration);this.life=200}i.displayName="Shot";var t=F(i,e).prototype,r=i;t.step=function(){var e,t,r,i,s,o,u,a,f,l,c,h,p;this.x+=this.dx;this.y+=this.dy;this.dx*=this.decel;this.dy*=this.decel;if(this.attributes.homingAmmo&&!this.target.dead){e=Math.atan2(this.target.y-this.y,this.target.x-this.x);this.dx=n(Math.cos(e)*this.attributes.ammoSpeed,this.dx,.2);this.dy=n(Math.sin(e)*this.attributes.ammoSpeed,this.dy,.2)}if(!(this.life--)||Math.abs(this.dx+this.dy)<.1)this.dead=!0;t=0|this.x/32;r=0|this.y/32;i=this.x-this.initialX;s=this.y-this.initialY;i*i+s*s>=this.rangeSq&&(this.dead=!0);for(o=0,a=(u=_.creeps).length;o<a;++o){f=u[o];if(f.gridY!=r)continue;l=this.x-f.x;c=this.y-f.y;h=Math.max(4,f.actualSize);if(l*l+c*c<h*h){f.damage(this.attributes.ammoDamage);this.attributes.slowingAmmo&&(f.actualSpeed*=.95);this.dead=!0;break}}for(o=0,a=(u=_.objs).length;o<a;++o){p=u[o];if(p.blocking&&t==p.gridX&&r==p.gridY){this.dead=!0;break}}};t.draw=function(e){e.beginPath();e.lineWidth=1;e.strokeStyle="white";e.fillStyle=this.fillStyle;e.save();e.rotate(D*this.attributes.ammoSpeed);e.rect(-this.size,-this.size,this.size*2,this.size*2);e.fill();e.stroke();e.restore()};return i}(E);L=function(){function n(){this.towers=[];this.creeps=[];this.ammo=[];this.towerTray=[];this.objs=[];this.enemyMutationRate=.09;this.towerMutationRate=.04;this.heart=null;this.credits=0;this.gameOver=!1}n.displayName="World";var e=n.prototype,t=n;e.getAstarNeighbors=function(e){var t,n,r,i,s;t=[];for(n=-1;n<=1;++n)for(r=-1;r<=1;++r){if(n==0&&r==0)continue;i=e.x+n;s=e.y+r;this.isRoutable(i,s)&&t.push(c(i,s))}return t};e.checkGridObj=function(e,t,n,r){var i,s,o;r==null&&(r=!1);for(i=0,s=e.length;i<s;++i){o=e[i];if(r&&!o.blocking)continue;if(o.gridX==t&&o.gridY==n)return o}return!1};e.isRoutable=function(e,t){return A(e,t)?this.checkGridObj(this.towers,e,t)?!1:this.checkGridObj(this.objs,e,t,!0)?!1:!0:!1};e.isPlaceable=function(e,t){return A(e,t)?this.checkGridObj(this.towers,e,t)?!1:this.checkGridObj(this.objs,e,t)?!1:!0:!1};e.placeTower=function(e,t,n){var r,i,s,o,u,a,f=[];for(r=0,i=this.towerTray.length;r<i;++r)if(this.towerTray[r]==e){this.towerTray.splice(r,1);break}e.setGridCoords(t,n);this.towers.push(e);m("place");for(s=0,u=(o=this.creeps).length;s<u;++s){a=o[s];f.push(a.reroute())}return f};e._process=function(e){var t,n;t=0;while(t<e.length){n=e[t];typeof n.step=="function"&&n.step();if(n.x<0||n.y<0||n.x>800||n.y>544)n.dead=!0;if(n.dead){e.splice(t,1);continue}t+=1}return e};e.draw=function(e){var t,n,r,i,s,o,u,a,f=[];t=[].concat(this._process(this.creeps),this._process(this.towers),this._process(this.objs),this._process(this.ammo));this.heart.health<=0&&(this.gameOver=!0);t.sort(function(e,t){return e.y-t.y});for(n=0,r=t.length;n<r;++n){i=t[n];e.translate(i.x,i.y);i.draw(e);e.translate(-i.x,-i.y);if(P.routes){s=i.route;e.lineWidth=1;e.strokeStyle="rgba(255,0,0,0.6)";if(s){e.beginPath();e.moveTo(i.x,i.y);for(o=0,u=s.length;o<u;++o){a=s[o];e.lineTo(a.worldX,a.worldY)}f.push(e.stroke())}}}return f};e.createBoulder=function(){var e,t,n,r;e=new N;for(t=0;t<30;++t){n=s(3,O-3);r=s(0,M-1);if(this.isPlaceable(n,r)){e.setGridCoords(n,r);this.objs.push(e);return e}}};e.newGame=function(){var e,t,n,r;this.credits=15;for(e=0;e<7;++e)this.towerTray.push(new S(H.initialize()));t=new x;t.setGridCoords(0,0|Math.random()*M-1);this.objs.push(t);this.heart=n=new T;n.setGridCoords(O-1,0|Math.random()*M-1);this.objs.push(n);for(r=0;r<10;++r)this.createBoulder()};e.sellTower=function(e){var t,n,r,i;for(t=0,r=(n=this.towers).length;t<r;++t){i=n[t];if(e==i){e.onStage=!1;this.towers.splice(t,1);this.credits+=3;m("sell");break}}};e.cloneTower=function(e){var t;m("clone");t=new S(H.evolve(e.attributes,e.attributes,this.towerMutationRate));this.towerTray.push(t);t.generation=e.generation;this.credits-=10};e.totalEnemiesLeft=function(){var e,t,n,r,i;e=0;for(t=0,r=(n=this.objs).length;t<r;++t){i=n[t];i.enemiesLeft&&(e+=i.enemiesLeft)}return e};return n}();A=function(e,t){return e>=0&&e<O&&t>=0&&t<M};O=25;M=17;_=null;D=0;P={routes:!1};H=new w({height:new b,baseWidth:new b,topWidth:new b,form:new b,range:new b,hue:new b,hueTop:new b,ammoSpeed:new b,ammoDamage:new b,ammoRange:new b,ammoDeceleration:new b,shootSpeed:new b,reloadAmmo:new b,reloadSpeed:new b,acquisitionSpeed:new b,maxRange:new b,slowingAmmo:new b,homingAmmo:new b});B={maxAmmo:"Ammo/reload",shotInterval:"Shot Speed",acqInterval:"Acquisition Speed",maxRange:"Acquisition Range",reloadTime:"Reload Time",ammoDamage:"Ammo Damage",ammoSpeed:"Ammo Speed",ammoRange:"Ammo Range",ammoDeceleration:"Ammo Deceleration",dps:"DPS"};j=new w({speed:new b,health:new b,hue:new b,size:new b,flying:new b});(function(e,t){var n,r,s,o,u,a,f,c,h,p,g,y,b,w,E,x,T,N;n=null;r=null;s={b:!1,x:0,y:0,down:{}};o=null;u=null;a=null;f=null;c=function(e){a=e+""};h=function(){var e,t;r.beginPath();r.strokeStyle="purple";r.lineWidth=1;for(e=0;e<800;e+=32){r.moveTo(e+.5,0);r.lineTo(e+.5,544)}for(t=0;t<544;t+=32){r.moveTo(0,t+.5);r.lineTo(800,t+.5)}return r.stroke()};p=function(){var e,t,n,a,l,h,p,d,v,g,y;if(o&&A(s.gridX,s.gridY)){e=_.isPlaceable(s.gridX,s.gridY);r.beginPath();r.strokeStyle=e?"white":"red";r.lineWidth=2;r.rect(s.gridX*32,s.gridY*32,32,32);r.stroke();e&&c("Place tower")}u&&!u.onStage&&(u=null);t=!1;n=!0;if(_.towerTray.length>=10){n=!1;a="Too many towers in tray"}if(_.credits<5){n=!1;a="Not enough credits"}l=null;if(!o)for(h=0,d=(p=_.towers).length;h<d;++h){v=p[h];if(u==v||v.gridX==s.gridX&&v.gridY==s.gridY){f=v;if(u&&u!=v)if(n){l=v;r.strokeStyle="magenta";c("Evolve towers (5 CR)");r.lineWidth=1;r.beginPath();for(g=0;g<3;++g){r.moveTo(v.x+i(-5,5),v.y+i(-5,5));r.lineTo(u.x+i(-5,5),u.y+i(-5,5))}r.stroke()}else{r.strokeStyle="red";c("Can't evolve: "+a)}r.beginPath();r.strokeStyle=u==v?"magenta":"purple";r.lineWidth=4;r.rect(v.gridX*32,v.gridY*32,32,32);r.stroke();if(s.b)if(n&&u&&u!=v){m("evolve");y=new S(H.evolve(u.attributes,v.attributes,_.towerMutationRate));y.generation=Math.max(u.generation,v.generation)+1;_.credits-=5;_.towerTray.push(y);u=null;o=y}else{u=v;t=!0}}}l&&(f=l);if(u){r.strokeStyle="silver";r.lineWidth=1;r.beginPath();r.arc(u.x,u.y,u.actual.maxRange,0,6.282);r.stroke();r.strokeStyle="gray";r.beginPath();r.arc(u.x,u.y,u.actual.ammoRange,0,6.282);r.stroke()}return _.draw(r)};g=function(){var e,t,n,i,a,h;r.strokeStyle="cyan";r.lineWidth=1;r.beginPath();r.moveTo(0,544);r.lineTo(800,544);r.moveTo(800,0);r.lineTo(800,600);r.stroke();r.beginPath();r.fillStyle="silver";r.font="14px "+l;e=_.totalEnemiesLeft();if(_.gameOver){r.fillStyle="red";r.fillText("GAME OVER.",820,530)}else if(e<=0){r.fillStyle="lime";r.fillText("YOU WIN!",820,530)}r.fillText("Credits: "+_.credits,820,550);r.fillText("Core Health: "+_.heart.health,820,570);r.fillText("Enemies Left: "+e,820,590);_.towerTray.length==0&&r.fillText("Click on two towers to evolve them!",16,570);if(_.towers.length==0){r.fillStyle=D*4%1<.5?"silver":"white";r.fillText("Click on a tower below to place it.",16,530)}for(t=0,i=(n=_.towerTray).length;t<i;++t){a=n[t];r.save();h=16+t*32;r.translate(h,585);if(s.x>=h-16&&s.x<h+16&&s.y>544||o==a){o!=a&&c("Select tower to place");if(s.b){o=a;u=null}r.beginPath();r.strokeStyle=a==o?"white":"magenta";r.rect(-15,-15,30,30);r.stroke();f=a}a.draw(r);r.restore()}};y=function(){var e,t,n,i,s,o,u,a,c;r.font="14px "+l;r.beginPath();r.fillStyle="white";e=20;t=[];t.push("Generation "+f.generation);for(n in i=f.actual){s=i[n];if(n=B[n]){o=s==(0|s)?s+"":s.toFixed(2);t.push(n+": "+o)}}t.push("");f.actual.maxAmmo<10&&t.push("Low ammo");f.actual.reloadTime>5&&t.push("Slow reload");f.actual.maxRange<50&&t.push("Low range of acquisition");f.actual.acqInterval>3&&t.push("Slow acquisition");f.actual.ammoRange<120&&t.push("Low-range ammo");f.actual.ammoDamage<12&&t.push("Low damage ammo");f.actual.shotInterval<.1&&t.push("Rapid fire");f.actual.ammoSpeed>12&&t.push("Fast ammo");f.actual.ammoDamage>30&&t.push("High ammo damage");f.actual.maxRange>150&&t.push("Long range of acquisition");f.actual.ammoRange>250&&t.push("Long-range ammo");f.actual.acqInterval<2&&t.push("Fast acquisition");f.actual.reloadTime<2&&t.push("Fast reload");f.actual.slowingAmmo&&t.push("Ammo slows enemies");f.actual.homingAmmo&&t.push("Ammo homes on enemies");if(f.onStage){t.push("");t.push("[S] Sell tower (+3 CR)");_.credits>=10&&t.push("[C] Clone tower (-10 CR)")}for(u=0,a=t.length;u<a;++u){c=t[u];r.fillText(c,815,e);e+=20}};b=function(){var e,t,n;r.fillStyle="#000";r.fillRect(0,0,1024,600);a=null;f=null;p();r.fillStyle="#000";r.fillRect(800,0,224,600);g();f&&y();if(a){r.font="12px "+l;e=r.measureText(a).width;t=s.x+10;t+e+5>800&&(t=s.x-10-e);n=Math.min(580,s.y-5);t+=.5;n+=.5;r.fillStyle="rgba(0,0,0,0.5)";r.strokeStyle="white";r.lineWidth=1;r.beginPath();r.rect(t,n,e+6,16);r.fill();r.stroke();r.beginPath();r.fillStyle="white";r.fillText(a,t+2,n+12)}};w=function(){var e,t;e=s.gridX;t=s.gridY;if(o&&A(e,t)){o&&_.isPlaceable(e,t)&&_.placeTower(o,e,t);o=null}u&&A(e,t)&&_.isPlaceable(e,t)&&(u=null)};E=function(e){e==115&&f&&f.onStage&&_.sellTower(f);e==99&&f&&_.credits>=10&&_.towerTray.length<10&&_.cloneTower(f);if(e==97&&_.towerTray.length>0)return o=_.towerTray[0]};x=function(){D+=1/22;return b()};T=function(){_=new L;return _.newGame()};N=function(){var t,i;t=function(t){return e.getElementById(t)};n=t("canvas");r=n.getContext("2d");i=function(e,t){var n,r;e.x=t.offsetX||t.clientX;e.y=t.offsetY||t.clientY;n=0|e.x/32;r=0|e.y/32;if(A(n,r)){e.gridX=n;return e.gridY=r}return e.gridX=e.gridY=-1};n.addEventListener("mousedown",function(e){s.b=!0;i(s,e);i(s.down,e)},!1);n.addEventListener("mouseup",function(e){s.b=!1;i(s,e)},!1);n.addEventListener("mousemove",function(e){i(s,e)},!1);n.addEventListener("click",function(e){i(s,e);w()},!1);e.addEventListener("keypress",function(e){E(e.keyCode||e.charCode)},!1);v("core-hit","core-hit2.wav");v("ammo-hit","ammo-hit.wav");v("kill","kill.wav");v("tower-hurt","tower-hurt.wav");v("place","place.wav");v("shoot","shoot.wav");v("evolve","evolve.wav");v("clone","clone.wav");v("sell","sell.wav");T();return setInterval(x,1e3/22)};t.EvoTD={init:N,debug:P,newGame:T,getWorld:function(){return _},setSounds:function(e){return d=!!e}}}).call(this,document,window)}).call(this);